<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="AutoArena Application">
    <meta name="keywords" content="AutoArena, springboot, html, thymeleaf">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title th:text="${pageTitle}"></title>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}"/>

    <div th:replace="~{fragments/privateCSS :: privateCss}"></div>

</head>

<body>

<div id="wrapper">

    <div th:replace="~{fragments/privateHeader :: headerFragment}"></div>

    <div th:replace="~{fragments/privateLeftMenu :: leftMenuFragment}"></div>

    <div class="main">
        <div class="main-content">
            <div class="container-fluid">
                <h3 class="page-title"><p th:text="${pageTitle}"></p></h3>

                <div class="panel panel-headline demo-icons">
                    <!--
                    <div class="panel-heading">
                        <h4 class="panel-title" id="formTitle">Cadastrar Novo Modelo</h4>
                    </div>
                    -->
                    <div class="panel-body">
                        <form id="modeloForm" th:object="${modelo}" th:action="@{/private/cadastro/modelos}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <input type="hidden" id="modeloId" th:field="*{id}" />


                            <div class="form-group col-md-3">
                                <label for="tipoVeiculoSelect">Tipo de Veículo</label>
                                <select id="tipoVeiculoSelect" th:field="*{tipoVeiculo.id}" class="form-control" required>
                                    <option value="">Selecione o Tipo de Veículo</option>
                                    <option th:each="tipo : ${tiposVeiculo}"
                                            th:value="${tipo.id}"
                                            th:text="${tipo.nome}"
                                            th:selected="${modelo.tipoVeiculo != null and modelo.tipoVeiculo.id == tipo.id}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('tipoVeiculo')}" th:errors="*{tipoVeiculo}" class="text-danger"></div>
                            </div>

                            <div class="form-group col-md-3">
                                <label for="montadoraSelect">Montadora</label>
                                <select id="montadoraSelect" th:field="*{montadora.id}" class="form-control" required>
                                    <option value="">Selecione a Montadora</option>
                                    <option th:each="montadora : ${montadoras}"
                                            th:value="${montadora.id}"
                                            th:text="${montadora.nome}"
                                            th:selected="${modelo.montadora != null and modelo.montadora.id == montadora.id}">
                                    </option>
                                </select>
                                <div th:if="${#fields.hasErrors('montadora')}" th:errors="*{montadora}" class="text-danger"></div>
                            </div>


                            <div class="form-group col-md-4">
                                <label for="nome">Nome</label>
                                <input type="text" id="nome" th:field="*{nome}" class="form-control" placeholder="Ex: Civic, Corolla, Uno" required>
                                <div th:if="${#fields.hasErrors('nome')}" th:errors="*{nome}" class="text-danger"></div>
                            </div>

                            <div class="form-group col-md-2">
                                <label>Status</label><br>
                                <label class="radio-inline">
                                    <input type="radio" id="enabledTrue" th:field="*{enabled}" th:value="true" checked> Ativo
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" id="enabledFalse" th:field="*{enabled}" th:value="false"> Inativo
                                </label>
                            </div>

                            <div class="form-group col-md-12">
                                <button type="submit" id="submitButton" class="btn btn-default">Salvar</button>
                                <button type="button" id="cancelButton" class="btn btn-default" style="display: none;">Cancelar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="panel panel-headline demo-icons">
                    <!--
                    <div class="panel-heading">
                        <h4 class="panel-title" th:text="${blockTitle}"></h4>
                        <p class="panel-subtitle" th:text="${blockSubtitle}"></p>
                    </div>
                    -->
                    <div class="panel-body">

                        <h4 class="panel-title" th:text="Filtros"></h4>
                        <hr>
                        <form method="get" th:action="@{/private/cadastro/modelos}">
                            <div class="row">
                                <div class="form-group col-md-2">
                                    <label for="filtroTipoVeiculoId">Tipo de Veículo</label>
                                    <select id="filtroTipoVeiculoId" name="tipoVeiculoId" class="form-control">
                                        <option value="">Todos</option>
                                        <option th:each="tipo : ${tiposVeiculo}"
                                                th:value="${tipo.id}"
                                                th:text="${tipo.nome}"
                                                th:selected="${filtroTipoVeiculoId != null and filtroTipoVeiculoId == tipo.id}">
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group col-md-2">
                                    <label for="filtroMontadoraId">Montadora</label>
                                    <select id="filtroMontadoraId" name="montadoraId" class="form-control">
                                        <option value="">Todas</option>
                                        <option th:each="montadora : ${montadoras}"
                                                th:value="${montadora.id}"
                                                th:text="${montadora.nome}"
                                                th:selected="${filtroMontadoraId != null and filtroMontadoraId == montadora.id}">
                                        </option>
                                    </select>
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="filtroNome">Nome</label>
                                    <input type="text" id="filtroNome" name="nome" class="form-control" th:value="${filtroNome}" placeholder="Nome do Modelo">
                                </div>
                                <div class="form-group col-md-1">
                                    <label for="filtroStatus">Status</label>
                                    <select id="filtroStatus" name="enabled" class="form-control">
                                        <option value="">Todos</option>
                                        <option value="true" th:selected="${filtroStatus != null and filtroStatus == true}">Ativo</option>
                                        <option value="false" th:selected="${filtroStatus != null and filtroStatus == false}">Inativo</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-2">
                                    <label for="filtroOrdenacao">Ordenar por</label>
                                    <select id="filtroOrdenacao" name="sort" class="form-control">
                                        <option value="">Selecione</option>
                                        <option value="id,asc" th:selected="${sort != null and sort == 'id,asc'}">ID (Crescente)</option>
                                        <option value="id,desc" th:selected="${sort != null and sort == 'id,desc'}">ID (Decrescente)</option>
                                        <option value="nome,asc" th:selected="${sort != null and sort == 'nome,asc'}">Nome (A-Z)</option>
                                        <option value="nome,desc" th:selected="${sort != null and sort == 'nome,desc'}">Nome (Z-A)</option>
                                        <option value="montadora.nome,asc" th:selected="${sort != null and sort == 'montadora.nome,asc'}">Montadora (A-Z)</option>
                                        <option value="montadora.nome,desc" th:selected="${sort != null and sort == 'montadora.nome,desc'}">Montadora (Z-A)</option>
                                        <!--<option value="enabled,desc" th:selected="${sort != null and sort == 'enabled,desc'}">Status (Ativo primeiro)</option>-->
                                    </select>
                                </div>

                                <div class="form-group col-md-2">
                                    <label for="filtroTamanho">Exibir Itens por página</label>
                                    <select id="filtroTamanho" name="size" class="form-control">
                                        <!--<option value="2" th:selected="${size == 2}">2</option>-->
                                        <option value="5" th:selected="${size == 5}">5</option>
                                        <option value="10" th:selected="${size == 10}">10</option>
                                        <option value="15" th:selected="${size == 15}">15</option>
                                        <option value="20" th:selected="${size == 20}">20</option>
                                    </select>
                                </div>
                            </div>


                            <div class="form-group">
                                <button type="submit" class="btn btn-default">Filtrar e Ordenar</button>
                                <a th:href="@{/private/cadastro/modelos}" class="btn btn-default ">
                                    <!--<i class="fa fa-close"></i>-->
                                    Limpar Filtros
                                </a>
                            </div>
                        </form>

                        <hr>

                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo de Veículo</th>
                                    <th>Montadora</th>
                                    <th>Nome</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="modelo : ${modelos}">
                                    <td th:text="${modelo.id}"></td>
                                    <td th:text="${modelo.tipoVeiculo.nome}"></td>
                                    <td th:text="${modelo.montadora.nome}"></td>
                                    <td th:text="${modelo.nome}"></td>
                                    <td>
                                        <span th:if="${modelo.enabled}" class="label label-success">Ativo</span>
                                        <span th:unless="${modelo.enabled}" class="label label-danger">Inativo</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm edit-btn"
                                                th:data-id="${modelo.id}"
                                                th:data-nome="${modelo.nome}"
                                                th:data-montadora-id="${modelo.montadora.id}"
                                                th:data-tipoveiculo-id="${modelo.tipoVeiculo.id}"
                                                th:data-enabled="${modelo.enabled}">
                                            Editar
                                        </button>
                                        <form th:action="@{/private/cadastro/modelos/alterar-status}" method="post" style="display:inline;">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <input type="hidden" name="id" th:value="${modelo.id}" />
                                            <input type="hidden" name="enabled" th:value="${!modelo.enabled}" />
                                            <!--
                                            <button type="submit" class="btn btn-warning btn-sm">
                                                <span th:text="${modelo.enabled} ? 'Desativar' : 'Ativar'"></span>
                                            </button>
                                            -->
                                            <button type="submit"
                                                    th:classappend="${modelo.enabled} ? 'btn-default' : 'btn-success'"
                                                    class="btn btn-sm">
                                                <span th:text="${modelo.enabled} ? 'Desativar' : 'Ativar'"></span>
                                            </button>
                                        </form>
                                        <form th:action="@{/private/cadastro/modelos/excluir}" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja excluir este modelo?');">
                                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                            <input type="hidden" name="id" th:value="${modelo.id}" />
                                            <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                                        </form>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(modelos)}">
                                    <td colspan="6" class="text-center">Nenhum modelo encontrado.</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>


                        <div th:if="${page.totalPages > 0}" class="text-center">
                            <ul class="pagination">
                                <li th:class="${page.first ? 'disabled' : ''}">
                                    <a th:href="@{/private/cadastro/modelos(page=${0}, size=${size}, sort=${sort}, id=${filtroId}, tipoVeiculoId=${filtroTipoVeiculoId}, montadoraId=${filtroMontadoraId}, modeloId=${filtroModeloId}, placa=${filtroPlaca})}">
                                        &laquo;
                                    </a>
                                </li>
                                <!--
                                <li th:class="${page.first ? 'disabled' : ''}">
                                    <a th:href="@{/private/cadastro/modelos(page=${page.number - 1}, size=${size}, sort=${sort}, id=${filtroId}, tipoVeiculoId=${filtroTipoVeiculoId}, montadoraId=${filtroMontadoraId})}">
                                        &lsaquo;
                                    </a>
                                </li>
                                -->
                                <li th:each="i : ${#numbers.sequence(0, page.totalPages - 1)}" th:class="${page.number == i ? 'active' : ''}">
                                    <a th:href="@{/private/cadastro/modelos(page=${i}, size=${size}, sort=${sort}, id=${filtroId}, tipoVeiculoId=${filtroTipoVeiculoId}, montadoraId=${filtroMontadoraId})}" th:text="${i + 1}"></a>
                                </li>
                                <!--
                                <li th:class="${page.last ? 'disabled' : ''}">
                                    <a th:href="@{/private/cadastro/modelos(page=${page.number + 1}, size=${size}, sort=${sort}, id=${filtroId}, tipoVeiculoId=${filtroTipoVeiculoId}, montadoraId=${filtroMontadoraId})}">
                                        &rsaquo;
                                    </a>
                                </li>
                                -->
                                <li th:class="${page.last ? 'disabled' : ''}">
                                    <a th:href="@{/private/cadastro/modelos(page=${page.totalPages - 1}, size=${size}, sort=${sort}, id=${filtroId}, tipoVeiculoId=${filtroTipoVeiculoId}, montadoraId=${filtroMontadoraId})}">
                                        &raquo;
                                    </a>
                                </li>
                            </ul>
                        </div>

                    </div>
                </div>



            </div>

            </div>
        </div>
    </div>

    <div th:replace="~{fragments/privateFooter :: footerFragment}"></div>

</div>

<div th:replace="~{fragments/privateScriptsJS :: privateScriptsJs}"></div>

<script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        // Cache de elementos do DOM
        var $modeloForm = $('#modeloForm');
        var $formTitle = $('#formTitle');
        var $idInput = $('#modeloId');
        var $nomeInput = $('#nome');
        var $montadoraSelect = $('#montadoraSelect');
        var $tipoVeiculoSelect = $('#tipoVeiculoSelect');
        var $enabledTrueRadio = $('#enabledTrue');
        var $enabledFalseRadio = $('#enabledFalse');
        var $submitButton = $('#submitButton');
        var $cancelButton = $('#cancelButton');

        // Função para resetar o formulário e voltar ao modo de cadastro
        function resetForm() {
            $modeloForm[0].reset(); // Reseta os campos do formulário
            $idInput.val(''); // Limpa o ID oculto
            $formTitle.text('Cadastrar Novo Modelo');
            //$submitButton.text('Salvar').removeClass('btn-info').addClass('btn-primary'); // Garante que o botão volta a "Salvar" e cor primária
            $cancelButton.hide();
            // Garante que o radio 'Ativo' esteja checado por padrão ao resetar
            $enabledTrueRadio.prop('checked', true);

            // Remove mensagens de erro de validação do Thymeleaf, se houver
            $('.text-danger').text('');
            $('.form-group').removeClass('has-error');
        }

        // --- Lógica para repopular o formulário e exibir o modo de edição após um redirect (e.g., erro de validação) ---
        var initialModeloId = /*[[${modelo.id}]]*/ null;
        var initialNome = /*[[${modelo.nome}]]*/ '';
        var initialMontadoraId = /*[[${modelo.montadora != null ? modelo.montadora.id : null}]]*/ null;
        var initialTipoVeiculoId = /*[[${modelo.tipoVeiculo != null ? modelo.tipoVeiculo.id : null}]]*/ null;
        var initialEnabled = /*[[${modelo.enabled}]]*/ null; // Note: For primitive boolean, it will be true/false, not null, unless wrapper type used

        if (initialModeloId) {
            $formTitle.text('Editar Modelo (ID: ' + initialModeloId + ')');
            $idInput.val(initialModeloId);
            $nomeInput.val(initialNome);
            $montadoraSelect.val(initialMontadoraId);
            $tipoVeiculoSelect.val(initialTipoVeiculoId);

            if (initialEnabled !== null) { // Verificação para garantir que a propriedade enabled exista
                if (initialEnabled) {
                    $enabledTrueRadio.prop('checked', true);
                } else {
                    $enabledFalseRadio.prop('checked', true);
                }
            }
            //$submitButton.text('Atualizar Modelo').removeClass('btn-primary').addClass('btn-info'); // Define o texto e a cor do botão para edição
            $cancelButton.show();
        }


        // --- Exibição de mensagens Toastr ---
        var messageType = /*[[${messageType}]]*/ null;
        var message = /*[[${message}]]*/ null;

        console.log("Toastr Message Type:", messageType); // Debugging
        console.log("Toastr Message:", message); // Debugging

        if (message && messageType) {
            if (typeof toastr !== 'undefined') {
                if (messageType === 'success') {
                    toastr.success(message);
                } else if (messageType === 'error') {
                    toastr.error(message);
                } else if (messageType === 'warning') {
                    toastr.warning(message);
                }
            } else {
                console.warn("Toastr is not defined. Message:", messageType + ": " + message);
            }
        }

        // Lidar com o clique no botão "Editar" da tabela
        $('.edit-btn').on('click', function() {
            var id = $(this).data('id');
            var nome = $(this).data('nome');
            var montadoraId = $(this).data('montadora-id');
            var tipoVeiculoId = $(this).data('tipoveiculo-id');
            var enabled = $(this).data('enabled');

            $formTitle.text('Editar Modelo (ID: ' + id + ')');
            $idInput.val(id);
            $nomeInput.val(nome);
            $montadoraSelect.val(montadoraId);
            $tipoVeiculoSelect.val(tipoVeiculoId);

            if (enabled) {
                $enabledTrueRadio.prop('checked', true);
            } else {
                $enabledFalseRadio.prop('checked', true);
            }

            //$submitButton.text('Atualizar Modelo').removeClass('btn-primary').addClass('btn-info'); // Agora esta linha está ativa
            $cancelButton.show();
            // Scrolla para o topo para mostrar o formulário
            $('html, body').animate({
                scrollTop: $modeloForm.offset().top - 100
            }, 500);

            // Limpa as mensagens de erro de validação que podem ter vindo de um POST anterior
            $('.text-danger').text('');
            $('.form-group').removeClass('has-error');
        });

        // Lidar com o botão Cancelar Edição
        $cancelButton.on('click', function() {
            resetForm();
        });
    });
    /*]]>*/
</script>

</body>
</html>